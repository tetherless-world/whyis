<div>
    <template>
        <div>
          <div v-if="loading">
            <spinner :loading="loading" :text='loadingText'/>
          </div>
          <div v-else-if="!authenticated">
            <div>Error: user must be logged in to access this page.</div>
          </div>
          <div v-else>
           <div class=""></div>
            <!--------->
            <div class="card" style="margin: 10px">
                <form class="modal-content" action="" method="post" 
                  enctype="multipart/form-data" 
                  upload_type="http://www.w3.org/ns/dcat#Dataset">
                <!-- Bootstrap stepper equivalent using nav-tabs -->
                <div class="card-body">
                  <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" :class="{active: active === 'first'}" 
                              type="button" role="tab" 
                              :disabled="!first">Upload files</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" :class="{active: active === 'second'}" 
                              type="button" role="tab" 
                              :disabled="!second">Provide additional info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" :class="{active: active === 'third'}" 
                              type="button" role="tab" 
                              :disabled="!third">Confirm and Submit</button>
                    </li>
                  </ul>
                  <div class="tab-content">
        
                  <div class="tab-pane fade" :class="{show: active === 'first', active: active === 'first'}" 
                       id="first" role="tabpanel">  
                     <div style="margin: 20px">

                      <div class="form-floating mb-3"> 
                        <input type="text" class="form-control" id="doi" v-model="doi" placeholder="DOI of related publication">
                        <label for="doi">DOI of related publication (e.g., 10.1000/000)</label>
                      </div>
        
                        <div class="mb-3" :class="{ 'is-invalid': isInvalidUpload }"> 
                          <label for="distrFiles" class="form-label">Select files to upload for this dataset</label>
                          <input type="file" class="form-control" id="distrFiles" multiple required
                            v-on:change="handleDistrUpload($event.target.files)"/> 
                          <div v-if="distrStatus === 3" class="invalid-feedback d-block">Error in upload. Please try again</div>
                          <div v-if="isInvalidUpload" class="invalid-feedback">At least one distribution is required</div>
                        </div>
                        <div class="large-12 medium-12 small-12 cell" style="margin:20px">
                          <div 
                            v-for="(file, key) in uploadedFiles" 
                            v-bind:key="key + 'listing'"
                            class="file-listing">
                            <div class="row align-items-center" style="margin-left:10px;">
                              <div class="col">{{ file.name }} </div>
                              <div class="col">
                                <div class="form-floating">
                                  <input type="text" class="form-control" v-model="file.label" id="label-{{key}}">
                                  <label for="label-{{key}}">Label</label>
                                  <div class="form-text">Provide a human-readable label or leave as the default</div>
                                </div>
                              </div>
                              <div class="col-auto">
                                <button type="button" class="btn btn-outline-danger" v-on:click="removeFile( key )">Remove file</button> 
                              </div>
                            </div>
                          </div>
                        </div>  
              
                        <div class="mb-3">
                          <label for="repImgUploader" class="form-label">Select a representative image to use as thumbnail</label>
                          <input type="file" class="form-control" id="repImgUploader" accept="image/*" 
                            v-on:change="handleImgUpload($event.target.files); previewFile()"/>
                          <div v-if="depictStatus === 3" class="text-danger">Error in upload. Please try again</div>
                        </div>
                        <div id="depictWrapper" style="margin-left: 40px; visibility: hidden;">
                          <figure>
                            <img id="depictImg" src="" alt="Image preview..."  style="height:200px"> 
                            <figcaption>{{ dataset.depiction.name }}</figcaption>
                          </figure> 
                          <button type="button" class="btn btn-outline-secondary ms-2" @click="removeImage()">Remove image</button>
                        </div>
                      </div>
                      <div class="row align-items-center">
                        <div class="col-auto">
                          <button type="button" class="btn btn-primary" @click="checkFirstPage()">
                            Upload and continue
                          </button> 
                        </div>
                        <div class="col-auto" v-if="doiLoading">
                          <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                        </div>
                        <div class="col">
                        </div>
                        <div class="col">
                        </div>
                      </div>
    
                    </div>
        
        
                    <div class="tab-pane fade" :class="{show: active === 'second', active: active === 'second'}" 
                         id="second" role="tabpanel">
                    
                      <div class="row">
        
                        <!---------- General Info fields ---------->
                        <div class="col-12" style="margin: 20px">
                          <h3 class="h4 mt-2">
                            General Information
                          </h3>
                          <div class="form-floating mb-3" :class="{ 'is-invalid': (isInvalidForm && (dataset.title === ''))}"> 
                            <input type="text" class="form-control" id="title" v-model="dataset.title" required placeholder="Title">
                            <label for="title">Title</label>
                            <div v-if="isInvalidForm && (dataset.title === '')" class="invalid-feedback">Title required</div>
                          </div>


                          <h5 class="mt-4">Contact Point</h5> 
                          <div class="row g-3 align-items-center">  

                            <div class="col-md-3">
                              <div class="form-floating" :class="{ 'is-invalid': (isInvalidForm && ((cpID === null) || (cpID==='')) )}">
                                <input type="text" class="form-control" id="cpID" v-model="cpID" required v-on:change="lookupOrcid()" placeholder="ORCID Identifier">
                                <label for="cpID">ORCID Identifier (e.g., 0000-0001-2345-6789)</label>
                                <div v-if="isInvalidForm && ((cpID === null) || (cpID===''))" class="invalid-feedback">ORCID iD required</div>
                              </div>
                            </div>
                      
                            <div class="col-md-2">
                              <div class="form-floating" :class="{ 'is-invalid': (isInvalidForm && (dataset.contactpoint.cpfirstname === ''))}">
                                <input type="text" class="form-control" id="cpfirstname" v-model="dataset.contactpoint.cpfirstname" required placeholder="First name">
                                <label for="cpfirstname">First name</label>
                                <div v-if="isInvalidForm && (dataset.contactpoint.cpfirstname === '')" class="invalid-feedback">Contact point required</div>
                              </div>
                            </div>
                      
                            <div class="col-md-2">
                              <div class="form-floating" :class="{ 'is-invalid': (isInvalidForm && (dataset.contactpoint.cplastname === ''))}">
                                <input type="text" class="form-control" id="cplastname" v-model="dataset.contactpoint.cplastname" required placeholder="Last name">
                                <label for="cplastname">Last name</label>
                                <div v-if="isInvalidForm && (dataset.contactpoint.cplastname === '')" class="invalid-feedback">Contact point required</div>
                              </div>
                            </div>
                      
                            <div class="col-md-3">
                              <div class="form-floating" :class="{ 'is-invalid': (isInvalidForm && (dataset.contactpoint.cpemail === ''))}">
                                <input type="email" class="form-control" id="cpemail" v-model="dataset.contactpoint.cpemail" required placeholder="Email">
                                <label for="cpemail">Email</label>
                                <div v-if="isInvalidForm && (dataset.contactpoint.cpemail === '')" class="invalid-feedback">Valid email required</div>
                              </div>
                            </div>
                          </div>

                          <div v-if="cpIDError" class="alert alert-danger text-center" style="margin-bottom: 20px;">
                            No results found for {{cpID}}
                          </div>

                          <div class="text-center mb-4">
                            Don't have an ORCID iD?
                            <a href="https://orcid.org/" target="_blank">Create one here</a>
                          </div>
        
                          <div class="form-floating mb-3" :class="{ 'is-invalid': (isInvalidForm && (dataset.description === ''))}">
                            <textarea class="form-control" id="description" v-model="dataset.description" required placeholder="Text Description" style="height: 120px"></textarea>
                            <label for="description">Text Description</label>
                            <div v-if="isInvalidForm && (dataset.description === '')" class="invalid-feedback">Description required</div>
                          </div>
     
                        </div>
                    
                        <hr class="my-4">
        
        
                        <!---------- Contributor fields -------->
                        <div class="col-12" style="margin: 20px">
                          <h3 class="h4 mt-2 mb-3"> 
                            Contributors
                          </h3>

                          <div>  
                            <!-- New Bootstrap autocomplete component for authors -->
                            <div class="mb-3">
                              <autocomplete 
                                v-model="selectedAuthorModel"
                                :fetch-data="resolveEntityAuthor"
                                :display-field="'label'"
                                :key-field="'node'"
                                @select="selectedAuthorChange"
                                placeholder="Search for Author"
                                input-class="form-control">
                                <template #option="{ item }">
                                  <span>{{ item.label || item.name }}</span>
                                </template>
                                <template #no-results="{ query }">
                                  <div>
                                    <p>No authors matching "{{ query }}" were found.</p>
                                    <button type="button" class="btn btn-link btn-sm" @click="showNewAuthor">Create new</button>
                                  </div>
                                </template>
                              </autocomplete>
                            </div>

                          <table class="table" width="100%" style="border-collapse: collapse;">
                            <tbody>
                              <tr > 
                              <td style="width:100%">  
                                <tr v-for="(row, index) in contributors" 
                                  v-bind:key="index + 'contr'" 
                                  style="border-top: 0.5pt lightgray solid"
                                >
                                  <td style="width:50%">
                                    {{contributors[index]['name']}}
                                  </td>
                                  <td v-if="editableOrgs" style="width:40%">
                                    <!-- New Bootstrap autocomplete component for organizations -->
                                    <autocomplete 
                                      v-model="row.onbehalfof"
                                      :fetch-data="resolveEntityInstitution"
                                      :display-field="'label'"
                                      :key-field="'node'"
                                      @select="(item) => selectedOrgChange(index, item)"
                                      placeholder="Organization"
                                      input-class="form-control">
                                      <template #option="{ item }">
                                        <span>{{ item.label || item.name }}</span>
                                      </template>
                                      <template #no-results="{ query }">
                                        <div>
                                          <p>No organizations matching "{{ query }}" were found.</p>
                                          <button type="button" class="btn btn-link btn-sm" @click="showNewInstitution">Create new</button>
                                        </div>
                                      </template>
                                    </autocomplete>
                                  </td>
                                  <td v-else="editableOrgs" style="width:30%"></td>
                                  <td>
                                    <a v-on:click="removeElement(index)" style="cursor: pointer" >Remove</a> 
                                  </td>
                                </tr>
                              </td> 
                              </tr>
                            </tbody>

                          </table> 
                          </div>
                        </div>
        
                        <hr class="my-4">
                    
                        <!-- -------- Publication Info fields -------- -->
                        <div class="col-12" style="margin: 20px">
                          <h3 class="h4 mt-2 mb-3">
                            Publication Information
                          </h3>
                      
                          <div class="w-100">
                            <div class="row g-3">
                              <div class="col-md-6">
                                <div class="form-floating">
                                  <input type="date" class="form-control" id="datepub" v-model="dataset.datepub['@value']" placeholder="Date Published">
                                  <label for="datepub">Date Published</label>
                                </div>
                              </div>
                      
                              <div class="col-md-6">
                                <div class="form-floating">
                                  <input type="date" class="form-control" id="datemod" v-model="dataset.datemod['@value']" placeholder="Date Last Modified">
                                  <label for="datemod">Date Last Modified</label>
                                </div>
                              </div>
                            </div>
                            
                          </div>
                        </div> 
                        <div class="d-flex gap-2 mb-3">
                          <button type="button" class="btn btn-primary" @click="checkSecondPage">Next</button>
                          <div v-if="isInvalidForm" class="text-danger align-self-center">Check for errors in required fields</div>
                        </div>
                      </div> 
                    </div>
        
                    <div class="tab-pane fade" :class="{show: active === 'third', active: active === 'third'}" 
                         id="third" role="tabpanel">
        
                      <h3 class="h4" style="margin: 10px">
                        Form Results
                      </h3>
                      <div class="card-body" style="margin: 20px">
                        <p><strong>Title:</strong> {{ dataset.title }}</p>
                        <p>
                          <strong>Contact Point:</strong> {{ dataset.contactpoint.cpfirstname }} 
                          {{ dataset.contactpoint.cplastname }} - 
                          {{ dataset.contactpoint.cpemail }}
                        </p>
                        <p><strong>Text Description:</strong> {{ dataset.description }}</p>
                        <p><strong>Contributors</strong></p>
                        <div
                          class="ms-3"
                          v-for="(elem, index) in contributors"
                          v-bind:key="index + 'resContr'"
                        >
                          <span>{{elem.name}}</span>
                          <template v-if="(elem.onbehalfof !== null)&&(elem.onbehalfof.name !== undefined)"> - {{elem.onbehalfof.name}}</template>
                        </div> 
                        
                        <p><strong>Date Published:</strong> {{ dataset.datepub['@value'] }}</p>
                        <p><strong>Date Last Modified:</strong> {{ dataset.datemod['@value'] }}</p>
                        <p><strong>Related publication:</strong></p>
                        <div class="ms-3">
                          {{ dataset.refby }}
                        </div>
                        <p class="mt-2"><strong>Distribution(s):</strong></p> 
                        <div 
                          v-for="(file, key) in uploadedFiles" 
                          v-bind:key="key+'confirm'" 
                          class="ms-3"> 
                          {{ file.name }} 
                        </div>
                        <p><strong>Representative Image:</strong> {{ rep_image }}</p>
                      </div>
        
                      <div class="d-flex gap-2 p-3">
                        <button type="button" class="btn btn-primary" v-on:click="submitForm">
                          Submit
                        </button>
                      </div>
        
                    </div>
                  </div>
                </div>
                </form>
              </div>
          </div>
        </div>
      </template>
    </div>
