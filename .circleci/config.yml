# whyis testing
# Adapted from https://circleci.com/blog/how-to-build-a-docker-image-on-circleci-2-0/
version: 2
jobs:
  install_and_test:
    docker:
      - image: cimg/python:3.9-node
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt upgrade
            sudo apt install -y libdb-dev
      - run:
          name: Install whyis per the documentation
          command: |
            python3 -m venv venv
            source venv/bin/activate
            pip install requests
            pip install -e .
      - run:
          name: Run tests
          command: |
            source venv/bin/activate
            whyis test
      - store_artifacts:
          path: /apps/whyis/test-results
      - store_test_results:
          path: /apps/whyis/test-results
  lint-js:
    docker:
      - image: node:12.6-stretch
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: cd whyis/static && npm install
      - run:
          name: Lint the code
          command: .circleci/lint-js.sh
      - store_artifacts:
          path: lint-results
  lint-py:
    docker:
      - image: cimg/python:3.9-node
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip3 install flake8 pycodestyle pylint vulture
      - run:
          name: Lint the code
          command: .circleci/lint-py.sh
      - store_artifacts:
          path: lint-results

workflows:
  version: 2
  build_lint:
    jobs:
      - lint-js
      - lint-py
      - install_and_test
